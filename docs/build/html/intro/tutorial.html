

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>入门教程 &mdash; MooQuant 0.2.1 文档</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="索引"
              href="../genindex.html"/>
        <link rel="search" title="搜索" href="../search.html"/>
    <link rel="top" title="MooQuant 0.2.1 文档" href="../index.html"/>
        <link rel="next" title="策略示例" href="examples.html"/>
        <link rel="prev" title="安装指南" href="install.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> MooQuant
          

          
          </a>

          
            
            
              <div class="version">
                0.2.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">基础</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">基本介绍</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">安装指南</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">入门教程</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id2">策略运行流程</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id3">策略编写流程</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">策略示例</a></li>
<li class="toctree-l1"><a class="reference internal" href="detail_install.html">环境搭建</a></li>
</ul>
<p class="caption"><span class="caption-text">进阶</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="run_algorithm.html">多种方式运行策略</a></li>
<li class="toctree-l1"><a class="reference internal" href="under_ide.html">通过 PyCharm 运行/调试</a></li>
<li class="toctree-l1"><a class="reference internal" href="optimizing_parameters.html">参数调优</a></li>
</ul>
<p class="caption"><span class="caption-text">开发</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../development/make_contribute.html">如何贡献代码</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/basic_concept.html">基本概念</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/event_source.html">扩展事件源</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/data_source.html">扩展数据源</a></li>
</ul>
<p class="caption"><span class="caption-text">其他</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../history.html">更新记录</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MooQuant</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>入门教程</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/intro/tutorial.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

/* nice headers on first paragraph of info/warning boxes */
.admonition .first {
    margin: -12px;
    padding: 6px 12px;
    margin-bottom: 12px;
    color: #fff;
    line-height: 1;
    display: block;
}
.admonition.warning .first {
    background: #f0b37e;
}
.admonition.note .first {
    background: #6ab0de;
}
.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}
</style>
<div class="section" id="intro-tutorial">
<span id="id1"></span><h1>入门教程<a class="headerlink" href="#intro-tutorial" title="永久链接至标题">¶</a></h1>
<p>在本教程中，我们假设 MooQuant 已经正确安装在您的系统中，并且已经完成了相应回测数据的同步，如果有任何安装相关的问题，请首先查看 <a class="reference internal" href="install.html#intro-install"><span class="std std-ref">安装指南</span></a></p>
<div class="section" id="id2">
<h2>策略运行流程<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p>我们从 <a class="reference internal" href="examples.html#intro-examples"><span class="std std-ref">策略示例</span></a> 中选取 <a class="reference internal" href="examples.html#intro-examples-buy-and-hold"><span class="std std-ref">第一个策略-买入&amp;持有</span></a> 来进行回测。</p>
<p>如果对于策略、数据路径存在疑问，请参考：<a class="reference internal" href="install.html#faq-examples-path"><span class="std std-ref">6.  策略样例以及数据路径相关问题：</span></a></p>
<p>在进行回测的过程中需要明确以下几个回测要素，您可通过生成config.yml传参 <a class="reference internal" href="install.html#intro-config"><span class="std std-ref">获取配置文件</span></a> 或者通过命令行传参：</p>
<ul class="simple">
<li>数据源路径</li>
<li>策略文件路径</li>
<li>回测起始时间</li>
<li>回测结束时间</li>
<li>起始资金</li>
<li>Benchmark</li>
</ul>
<p>假如我们的策略存放在了 <code class="code docutils literal"><span class="pre">./mooquant/examples/buy_and_hold.py</span></code> 路径下， 数据源存放在 <code class="code docutils literal"><span class="pre">./mooquant/bundle/</span></code> 路径下，回测的起始时间为 <code class="code docutils literal"><span class="pre">2016-06-01</span></code>, 结束时间为 <code class="code docutils literal"><span class="pre">2016-12-01</span></code>，我们给策略分配的起始资金为 <code class="code docutils literal"><span class="pre">100000</span></code>, Benchmark 设置为 <code class="code docutils literal"><span class="pre">000300.XSHG</span></code></p>
<p>那么我们通过如下命令来运行回测</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>mooquant run -f ./mooquant/examples/buy_and_hold.py -d ./mooquant/bundle/ -s <span class="m">2016</span>-06-01 -e <span class="m">2016</span>-12-01 --account stock <span class="m">100000</span> --benchmark <span class="m">000300</span>.XSHG
</pre></div>
</div>
<p>如果我们想要以图形的方式查看回测的结果， 则增加 <code class="code docutils literal"><span class="pre">--plot</span></code> 参数</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>mooquant run -f ./mooquant/examples/buy_and_hold.py -d ./mooquant/bundle/ -s <span class="m">2016</span>-06-01 -e <span class="m">2016</span>-12-01 --account stock <span class="m">100000</span> --benchmark <span class="m">000300</span>.XSHG --plot
</pre></div>
</div>
<img alt="https://raw.githubusercontent.com/ricequant/rq-resource/master/mooquant/buy_and_hold.png" src="https://raw.githubusercontent.com/ricequant/rq-resource/master/mooquant/buy_and_hold.png" />
<p>如果想把回测的数据保存下来，可以通过 <code class="code docutils literal"><span class="pre">-o</span></code> 参数将结果保存成 <code class="code docutils literal"><span class="pre">pkl</span></code> 文件。</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>mooquant run -f ./mooquant/examples/buy_and_hold.py -d ./mooquant/bundle/ -s <span class="m">2016</span>-06-01 -e <span class="m">2016</span>-12-01 --account stock <span class="m">100000</span> --benchmark <span class="m">000300</span>.XSHG --plot -o result.pkl
</pre></div>
</div>
<p>等回测结束后可以通过 <code class="code docutils literal"><span class="pre">pandas.read_pickle</span></code> 函数来读取数据进行之后的数据分析。</p>
<div class="highlight-python3"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">result_dict</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;result.pkl&#39;</span><span class="p">)</span>

<span class="n">result_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="c1"># [out]dict_keys([&#39;total_portfolios&#39;, &#39;summary&#39;, &#39;benchmark_portfolios&#39;, &#39;benchmark_positions&#39;, &#39;stock_positions&#39;, &#39;trades&#39;, &#39;stock_portfolios&#39;])</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id3">
<h2>策略编写流程<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<p>MooQuant 抽离了策略框架的所有技术细节，以API的方式提供给策略研发者用于编写策略，从而避免陷入过多的技术细节，而非金融程序建模本身。</p>
<p>MooQuant 的 API 主要分为三类：约定函数、数据查询和交易接口。</p>
<ul class="simple">
<li>约定函数: 作为 API 的入口函数，用户必须实现对应的约定函数才可以正确的使用MooQuant<ul>
<li><code class="xref py py-func docutils literal"><span class="pre">init()</span></code> : 初始化方法，会在程序启动的时候执行</li>
<li><a class="reference internal" href="../api/base_api.html#handle_bar" title="handle_bar"><code class="xref py py-func docutils literal"><span class="pre">handle_bar()</span></code></a>: bar数据更新时会自动触发调用</li>
<li><a class="reference internal" href="../api/base_api.html#before_trading" title="before_trading"><code class="xref py py-func docutils literal"><span class="pre">before_trading()</span></code></a>: 会在每天策略交易开始前调用</li>
<li><a class="reference internal" href="../api/base_api.html#after_trading" title="after_trading"><code class="xref py py-func docutils literal"><span class="pre">after_trading()</span></code></a>: 会在每天交易结束后调用</li>
</ul>
</li>
</ul>
<div class="highlight-python3"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># 在这个方法中编写任何的初始化逻辑。context对象将会在你的算法策略的任何方法之间做传递。</span>
<span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="c1"># 在context中保存全局变量</span>
    <span class="n">context</span><span class="o">.</span><span class="n">s1</span> <span class="o">=</span> <span class="s2">&quot;000001.XSHE&quot;</span>
    <span class="c1"># 实时打印日志</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RunInfo: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">run_info</span><span class="p">))</span>

<span class="c1"># before_trading此函数会在每天策略交易开始前被调用，当天只会被调用一次</span>
<span class="k">def</span> <span class="nf">before_trading</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;开盘前执行before_trading函数&quot;</span><span class="p">)</span>

<span class="c1"># 你选择的证券的数据更新将会触发此段逻辑，例如日或分钟历史数据切片或者是实时数据切片更新</span>
<span class="k">def</span> <span class="nf">handle_bar</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">bar_dict</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;每一个Bar执行&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;打印Bar数据：&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">bar_dict</span><span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">])</span>

<span class="c1"># after_trading函数会在每天交易结束后被调用，当天只会被调用一次</span>
<span class="k">def</span> <span class="nf">after_trading</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;收盘后执行after_trading函数&quot;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>至此，我们写出了一个“完整”的策略，但是该策略实际上什么也没有做。</p>
<p>接下来，我们需要获取数据，根据数据来确定我们的仓位逻辑，因此会使用到数据查询的 API 接口。</p>
<ul class="simple">
<li>数据查询<ul>
<li><code class="xref py py-func docutils literal"><span class="pre">all_instruments()</span></code> : 获取所有合约基础信息数据</li>
<li><code class="xref py py-func docutils literal"><span class="pre">instruments()</span></code> : 获取合约详细数据</li>
<li><code class="xref py py-func docutils literal"><span class="pre">history_bars()</span></code> : 获取某一合约的历史数据</li>
<li><code class="xref py py-func docutils literal"><span class="pre">current_snapshot()</span></code> : 获取当前快照数据</li>
<li><code class="xref py py-func docutils literal"><span class="pre">get_future_contracts()</span></code> : 获取期货可以交易合约列表</li>
<li><code class="xref py py-func docutils literal"><span class="pre">get_trading_dates()</span></code>: 获取交易日列表</li>
<li><code class="xref py py-func docutils literal"><span class="pre">get_previous_trading_date()</span></code> : 获取上一日交易日</li>
<li><code class="xref py py-func docutils literal"><span class="pre">get_next_trading_date()</span></code> : 获取下一个交易日</li>
<li><code class="xref py py-func docutils literal"><span class="pre">get_yield_curve()</span></code>: 获取收益率曲线</li>
<li><code class="xref py py-func docutils literal"><span class="pre">is_suspended()</span></code> : 判断某股票当天是否停牌</li>
<li><code class="xref py py-func docutils literal"><span class="pre">is_st_stock()</span></code> : 判断某股票是否为 *st</li>
</ul>
</li>
</ul>
<p>MooQuant金融、财务、合约历史数据等数据接口请查看 <a class="reference internal" href="../api/extend_api.html#api-extend-api"><span class="std std-ref">扩展 API</span></a></p>
<ul class="simple">
<li>bar_dict: 在 <a class="reference internal" href="../api/base_api.html#handle_bar" title="handle_bar"><code class="xref py py-func docutils literal"><span class="pre">handle_bar()</span></code></a> 中我们可以使用 <cite>bar_dict</cite> 来获取相应的 <code class="xref py py-class docutils literal"><span class="pre">Bar</span></code> 数据，<cite>bar_dict</cite> 是一个字典类型变量，直接通过传 <cite>key</cite> 的方式就可以获取到对应的 <code class="xref py py-class docutils literal"><span class="pre">Bar</span></code> 数据。</li>
<li>我们可以引用第三方库来帮我们生成相应的指标序列，比如使用 <a class="reference external" href="https://github.com/mrjbq7/ta-lib">TA-Lib</a> 来获取移动平均线序列。<a class="reference external" href="https://github.com/mrjbq7/ta-lib">TA-Lib</a> 的安装可以参考 <a class="reference internal" href="detail_install.html#intro-detail-install-talib"><span class="std std-ref">安装 TA-Lib</span></a> 相应文档。</li>
</ul>
<div class="highlight-python3"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">talib</span>

<span class="c1"># 在这个方法中编写任何的初始化逻辑。context对象将会在你的算法策略的任何方法之间做传递。</span>
<span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="c1"># 在context中保存全局变量</span>
    <span class="n">context</span><span class="o">.</span><span class="n">s1</span> <span class="o">=</span> <span class="s2">&quot;000001.XSHE&quot;</span>
    <span class="c1"># 实时打印日志</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RunInfo: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">run_info</span><span class="p">))</span>

    <span class="c1"># 设置这个策略当中会用到的参数，在策略中可以随时调用，这个策略使用长短均线，我们在这里设定长线和短线的区间，在调试寻找最佳区间的时候只需要在这里进行数值改动</span>
    <span class="n">context</span><span class="o">.</span><span class="n">SHORTPERIOD</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">context</span><span class="o">.</span><span class="n">LONGPERIOD</span> <span class="o">=</span> <span class="mi">120</span>


<span class="c1"># before_trading此函数会在每天策略交易开始前被调用，当天只会被调用一次</span>
<span class="k">def</span> <span class="nf">before_trading</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;开盘前执行before_trading函数&quot;</span><span class="p">)</span>

<span class="c1"># 你选择的证券的数据更新将会触发此段逻辑，例如日或分钟历史数据切片或者是实时数据切片更新</span>
<span class="k">def</span> <span class="nf">handle_bar</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">bar_dict</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;每一个Bar执行&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;打印Bar数据：&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">bar_dict</span><span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">])</span>

    <span class="c1"># 因为策略需要用到均线，所以需要读取历史数据</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">history_bars</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">LONGPERIOD</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;1d&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">)</span>

    <span class="c1"># 使用talib计算长短两根均线，均线以array的格式表达</span>
    <span class="n">short_avg</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">SMA</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">SHORTPERIOD</span><span class="p">)</span>
    <span class="n">long_avg</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">SMA</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">LONGPERIOD</span><span class="p">)</span>

    <span class="n">plot</span><span class="p">(</span><span class="s2">&quot;short avg&quot;</span><span class="p">,</span> <span class="n">short_avg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">plot</span><span class="p">(</span><span class="s2">&quot;long avg&quot;</span><span class="p">,</span> <span class="n">long_avg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># 计算现在portfolio中股票的仓位</span>
    <span class="n">cur_position</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">]</span><span class="o">.</span><span class="n">quantity</span>
    <span class="c1"># 计算现在portfolio中的现金可以购买多少股票</span>
    <span class="n">shares</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">cash</span><span class="o">/</span><span class="n">bar_dict</span><span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">]</span><span class="o">.</span><span class="n">close</span>

    <span class="c1"># 如果短均线从上往下跌破长均线，也就是在目前的bar短线平均值低于长线平均值，而上一个bar的短线平均值高于长线平均值</span>
    <span class="k">if</span> <span class="n">short_avg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">long_avg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">short_avg</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">long_avg</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">cur_position</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># 进行清仓</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;进行清仓&quot;</span><span class="p">)</span>

    <span class="c1"># 如果短均线从下往上突破长均线，为入场信号</span>
    <span class="k">if</span> <span class="n">short_avg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">long_avg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">short_avg</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">long_avg</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># 满仓入股</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;满仓入股&quot;</span><span class="p">)</span>

<span class="c1"># after_trading函数会在每天交易结束后被调用，当天只会被调用一次</span>
<span class="k">def</span> <span class="nf">after_trading</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;开盘前执行after_trading函数&quot;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>至此，我们已经获取到了开仓和平仓的信号，那么接下来就需要调用交易接口来进行交易了。</p>
<ul class="simple">
<li>交易接口: 我们提供了多种交易接口，以方便不同的使用需求<ul>
<li><code class="xref py py-func docutils literal"><span class="pre">order_shares()</span></code>: 【股票专用】指定股数交易</li>
<li><code class="xref py py-func docutils literal"><span class="pre">order_lots()</span></code>: 【股票专用】指定手数交易</li>
<li><code class="xref py py-func docutils literal"><span class="pre">order_value()</span></code>: 【股票专用】指定价值交易</li>
<li><code class="xref py py-func docutils literal"><span class="pre">order_percent()</span></code>:【股票专用】 一定比例下单</li>
<li><code class="xref py py-func docutils literal"><span class="pre">order_target_value()</span></code>: 【股票专用】按照目标价值下单</li>
<li><code class="xref py py-func docutils literal"><span class="pre">order_target_percent()</span></code>: 【股票专用】按照目标比例下单</li>
<li><code class="xref py py-func docutils literal"><span class="pre">buy_open()</span></code>: 【期货专用】买开</li>
<li><code class="xref py py-func docutils literal"><span class="pre">sell_close()</span></code>:【期货专用】 平买仓</li>
<li><code class="xref py py-func docutils literal"><span class="pre">sell_open()</span></code>: 【期货专用】卖开</li>
<li><code class="xref py py-func docutils literal"><span class="pre">buy_close()</span></code>: 【期货专用】平卖仓</li>
<li><code class="xref py py-func docutils literal"><span class="pre">cancel_order()</span></code>: 撤单</li>
<li><code class="xref py py-func docutils literal"><span class="pre">get_open_orders()</span></code>: 获取未成交订单数据</li>
</ul>
</li>
</ul>
<p>我们分别使用 <code class="xref py py-func docutils literal"><span class="pre">order_target_value()</span></code> 和 <code class="xref py py-func docutils literal"><span class="pre">order_shares()</span></code> 进行平仓和开仓的操作，顺便把日志相关的代码删除，就是一个完整的 <a class="reference internal" href="examples.html#intro-examples-golden-cross"><span class="std std-ref">Golden Cross算法示例</span></a> 了。</p>
<div class="highlight-python3"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">talib</span>

<span class="c1"># 在这个方法中编写任何的初始化逻辑。context对象将会在你的算法策略的任何方法之间做传递。</span>
<span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="c1"># 在context中保存全局变量</span>
    <span class="n">context</span><span class="o">.</span><span class="n">s1</span> <span class="o">=</span> <span class="s2">&quot;000001.XSHE&quot;</span>

    <span class="c1"># 设置这个策略当中会用到的参数，在策略中可以随时调用，这个策略使用长短均线，我们在这里设定长线和短线的区间，在调试寻找最佳区间的时候只需要在这里进行数值改动</span>
    <span class="n">context</span><span class="o">.</span><span class="n">SHORTPERIOD</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">context</span><span class="o">.</span><span class="n">LONGPERIOD</span> <span class="o">=</span> <span class="mi">120</span>


<span class="c1"># before_trading此函数会在每天策略交易开始前被调用，当天只会被调用一次</span>
<span class="k">def</span> <span class="nf">before_trading</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="c1"># 你选择的证券的数据更新将会触发此段逻辑，例如日或分钟历史数据切片或者是实时数据切片更新</span>
<span class="k">def</span> <span class="nf">handle_bar</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">bar_dict</span><span class="p">):</span>

    <span class="c1"># 因为策略需要用到均线，所以需要读取历史数据</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">history_bars</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">LONGPERIOD</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;1d&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">)</span>

    <span class="c1"># 使用talib计算长短两根均线，均线以array的格式表达</span>
    <span class="n">short_avg</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">SMA</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">SHORTPERIOD</span><span class="p">)</span>
    <span class="n">long_avg</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">SMA</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">LONGPERIOD</span><span class="p">)</span>

    <span class="n">plot</span><span class="p">(</span><span class="s2">&quot;short avg&quot;</span><span class="p">,</span> <span class="n">short_avg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">plot</span><span class="p">(</span><span class="s2">&quot;long avg&quot;</span><span class="p">,</span> <span class="n">long_avg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># 计算现在portfolio中股票的仓位</span>
    <span class="n">cur_position</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">]</span><span class="o">.</span><span class="n">quantity</span>
    <span class="c1"># 计算现在portfolio中的现金可以购买多少股票</span>
    <span class="n">shares</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">cash</span><span class="o">/</span><span class="n">bar_dict</span><span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">]</span><span class="o">.</span><span class="n">close</span>

    <span class="c1"># 如果短均线从上往下跌破长均线，也就是在目前的bar短线平均值低于长线平均值，而上一个bar的短线平均值高于长线平均值</span>
    <span class="k">if</span> <span class="n">short_avg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">long_avg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">short_avg</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">long_avg</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">cur_position</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># 进行清仓</span>
        <span class="n">order_target_value</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># 如果短均线从下往上突破长均线，为入场信号</span>
    <span class="k">if</span> <span class="n">short_avg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">long_avg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">short_avg</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">long_avg</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># 满仓入股</span>
        <span class="n">order_shares</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">,</span> <span class="n">shares</span><span class="p">)</span>

<span class="c1"># after_trading函数会在每天交易结束后被调用，当天只会被调用一次</span>
<span class="k">def</span> <span class="nf">after_trading</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</td></tr></table></div>
<p>可以看到，我们使用 plot 函数绘制内容，也出现在了输出的结果中。</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ mooquant run -s <span class="m">2014</span>-01-01 -e <span class="m">2016</span>-01-01 -f mooquant/examples/golden_cross.py --account stock <span class="m">100000</span> -p -bm <span class="m">000001</span>.XSHE
</pre></div>
</div>
<img alt="https://raw.githubusercontent.com/ricequant/rq-resource/master/mooquant/golden_cross.png" src="https://raw.githubusercontent.com/ricequant/rq-resource/master/mooquant/golden_cross.png" />
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="examples.html" class="btn btn-neutral float-right" title="策略示例" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="install.html" class="btn btn-neutral" title="安装指南" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, MooQuant.
      最后更新于 9月 13, 2017.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.2.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/translations.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
  
 
<script type="text/javascript">
    console.log("Powered By MooQuant.");
</script>


</body>
</html>