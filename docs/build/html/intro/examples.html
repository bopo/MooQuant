

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>策略示例 &mdash; MooQuant 0.2.1 文档</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="索引"
              href="../genindex.html"/>
        <link rel="search" title="搜索" href="../search.html"/>
    <link rel="top" title="MooQuant 0.2.1 文档" href="../index.html"/>
        <link rel="next" title="环境搭建" href="detail_install.html"/>
        <link rel="prev" title="入门教程" href="tutorial.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> MooQuant
          

          
          </a>

          
            
            
              <div class="version">
                0.2.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">基础</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">基本介绍</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">安装指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">入门教程</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">策略示例</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#intro-examples-buy-and-hold">第一个策略-买入&amp;持有</a></li>
<li class="toctree-l2"><a class="reference internal" href="#golden-cross">Golden Cross算法示例</a></li>
<li class="toctree-l2"><a class="reference internal" href="#macd">单股票 MACD 算法示例</a></li>
<li class="toctree-l2"><a class="reference internal" href="#rsi">多股票RSI算法示例</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id3">海龟交易系统</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id5">股指期货MACD日回测</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id6">商品期货跨品种配对交易</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="detail_install.html">环境搭建</a></li>
</ul>
<p class="caption"><span class="caption-text">进阶</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="run_algorithm.html">多种方式运行策略</a></li>
<li class="toctree-l1"><a class="reference internal" href="under_ide.html">通过 PyCharm 运行/调试</a></li>
<li class="toctree-l1"><a class="reference internal" href="optimizing_parameters.html">参数调优</a></li>
</ul>
<p class="caption"><span class="caption-text">开发</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../development/make_contribute.html">如何贡献代码</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/basic_concept.html">基本概念</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/event_source.html">扩展事件源</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/data_source.html">扩展数据源</a></li>
</ul>
<p class="caption"><span class="caption-text">其他</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../history.html">更新记录</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MooQuant</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>策略示例</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/intro/examples.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

/* nice headers on first paragraph of info/warning boxes */
.admonition .first {
    margin: -12px;
    padding: 6px 12px;
    margin-bottom: 12px;
    color: #fff;
    line-height: 1;
    display: block;
}
.admonition.warning .first {
    background: #f0b37e;
}
.admonition.note .first {
    background: #6ab0de;
}
.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}
</style>
<div class="section" id="intro-examples">
<span id="id1"></span><h1>策略示例<a class="headerlink" href="#intro-examples" title="永久链接至标题">¶</a></h1>
<p>在下面我们列举一些常用的算法范例，您可以通过MooQuant运行，也可以直接登录 <a class="reference external" href="https://www.ricequant.com/algorithms">Ricequant</a> 在线进行回测或模拟交易。</p>
<div class="section" id="intro-examples-buy-and-hold">
<span id="id2"></span><h2>第一个策略-买入&amp;持有<a class="headerlink" href="#intro-examples-buy-and-hold" title="永久链接至标题">¶</a></h2>
<p>万事开头难，这是一个最简单的策略：在回测开始的第一天买入资金量的100%的平安银行并且一直持有。</p>
<div class="highlight-python3"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># 在这个方法中编写任何的初始化逻辑。context对象将会在你的算法策略的任何方法之间做传递。</span>
<span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;init&quot;</span><span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">s1</span> <span class="o">=</span> <span class="s2">&quot;000001.XSHE&quot;</span>
    <span class="n">update_universe</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">)</span>
    <span class="c1"># 是否已发送了order</span>
    <span class="n">context</span><span class="o">.</span><span class="n">fired</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">context</span><span class="o">.</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">1</span>


<span class="k">def</span> <span class="nf">before_trading</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">bar_dict</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Before Trading&quot;</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">cnt</span><span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>


<span class="c1"># 你选择的证券的数据更新将会触发此段逻辑，例如日或分钟历史数据切片或者是实时数据切片更新</span>
<span class="k">def</span> <span class="nf">handle_bar</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">bar_dict</span><span class="p">):</span>
    <span class="n">context</span><span class="o">.</span><span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;handle_bar&quot;</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">cnt</span><span class="p">)</span>
    <span class="c1"># 开始编写你的主要的算法逻辑</span>

    <span class="c1"># bar_dict[order_book_id] 可以拿到某个证券的bar信息</span>
    <span class="c1"># context.portfolio 可以拿到现在的投资组合状态信息</span>

    <span class="c1"># 使用order_shares(id_or_ins, amount)方法进行落单</span>

    <span class="c1"># TODO: 开始编写你的算法吧！</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">fired</span><span class="p">:</span>
        <span class="c1"># order_percent并且传入1代表买入该股票并且使其占有投资组合的100%</span>
        <span class="n">order_percent</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">fired</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="golden-cross">
<span id="intro-examples-golden-cross"></span><h2>Golden Cross算法示例<a class="headerlink" href="#golden-cross" title="永久链接至标题">¶</a></h2>
<p>以下是一个我们使用TALib编写的golden cross算法的示例，使用了simple moving average方法：</p>
<div class="highlight-python3"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">talib</span>


<span class="c1"># 在这个方法中编写任何的初始化逻辑。context对象将会在你的算法策略的任何方法之间做传递。</span>
<span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="n">context</span><span class="o">.</span><span class="n">s1</span> <span class="o">=</span> <span class="s2">&quot;000001.XSHE&quot;</span>

    <span class="c1"># 设置这个策略当中会用到的参数，在策略中可以随时调用，这个策略使用长短均线，我们在这里设定长线和短线的区间，在调试寻找最佳区间的时候只需要在这里进行数值改动</span>
    <span class="n">context</span><span class="o">.</span><span class="n">SHORTPERIOD</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">context</span><span class="o">.</span><span class="n">LONGPERIOD</span> <span class="o">=</span> <span class="mi">120</span>


<span class="c1"># 你选择的证券的数据更新将会触发此段逻辑，例如日或分钟历史数据切片或者是实时数据切片更新</span>
<span class="k">def</span> <span class="nf">handle_bar</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">bar_dict</span><span class="p">):</span>
    <span class="c1"># 开始编写你的主要的算法逻辑</span>

    <span class="c1"># bar_dict[order_book_id] 可以拿到某个证券的bar信息</span>
    <span class="c1"># context.portfolio 可以拿到现在的投资组合状态信息</span>

    <span class="c1"># 使用order_shares(id_or_ins, amount)方法进行落单</span>

    <span class="c1"># TODO: 开始编写你的算法吧！</span>

    <span class="c1"># 因为策略需要用到均线，所以需要读取历史数据</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">history_bars</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">LONGPERIOD</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;1d&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">)</span>

    <span class="c1"># 使用talib计算长短两根均线，均线以array的格式表达</span>
    <span class="n">short_avg</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">SMA</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">SHORTPERIOD</span><span class="p">)</span>
    <span class="n">long_avg</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">SMA</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">LONGPERIOD</span><span class="p">)</span>

    <span class="n">plot</span><span class="p">(</span><span class="s2">&quot;short avg&quot;</span><span class="p">,</span> <span class="n">short_avg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">plot</span><span class="p">(</span><span class="s2">&quot;long avg&quot;</span><span class="p">,</span> <span class="n">long_avg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># 计算现在portfolio中股票的仓位</span>
    <span class="n">cur_position</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">]</span><span class="o">.</span><span class="n">quantity</span>
    <span class="c1"># 计算现在portfolio中的现金可以购买多少股票</span>
    <span class="n">shares</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">cash</span><span class="o">/</span><span class="n">bar_dict</span><span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">]</span><span class="o">.</span><span class="n">close</span>

    <span class="c1"># 如果短均线从上往下跌破长均线，也就是在目前的bar短线平均值低于长线平均值，而上一个bar的短线平均值高于长线平均值</span>
    <span class="k">if</span> <span class="n">short_avg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">long_avg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">short_avg</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">long_avg</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">cur_position</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># 进行清仓</span>
        <span class="n">order_target_value</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># 如果短均线从下往上突破长均线，为入场信号</span>
    <span class="k">if</span> <span class="n">short_avg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">long_avg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">short_avg</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">long_avg</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># 满仓入股</span>
        <span class="n">order_shares</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">,</span> <span class="n">shares</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="macd">
<h2>单股票 MACD 算法示例<a class="headerlink" href="#macd" title="永久链接至标题">¶</a></h2>
<p>以下是一个我们使用TALib编写的单股票MACD算法示例，使用了TALib的MACD方法：</p>
<div class="highlight-python3"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">talib</span>


<span class="c1"># 在这个方法中编写任何的初始化逻辑。context对象将会在你的算法策略的任何方法之间做传递。</span>
<span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="n">context</span><span class="o">.</span><span class="n">s1</span> <span class="o">=</span> <span class="s2">&quot;000001.XSHE&quot;</span>

    <span class="c1"># 使用MACD需要设置长短均线和macd平均线的参数</span>
    <span class="n">context</span><span class="o">.</span><span class="n">SHORTPERIOD</span> <span class="o">=</span> <span class="mi">12</span>
    <span class="n">context</span><span class="o">.</span><span class="n">LONGPERIOD</span> <span class="o">=</span> <span class="mi">26</span>
    <span class="n">context</span><span class="o">.</span><span class="n">SMOOTHPERIOD</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="n">context</span><span class="o">.</span><span class="n">OBSERVATION</span> <span class="o">=</span> <span class="mi">100</span>


<span class="c1"># 你选择的证券的数据更新将会触发此段逻辑，例如日或分钟历史数据切片或者是实时数据切片更新</span>
<span class="k">def</span> <span class="nf">handle_bar</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">bar_dict</span><span class="p">):</span>
    <span class="c1"># 开始编写你的主要的算法逻辑</span>

    <span class="c1"># bar_dict[order_book_id] 可以拿到某个证券的bar信息</span>
    <span class="c1"># context.portfolio 可以拿到现在的投资组合状态信息</span>

    <span class="c1"># 使用order_shares(id_or_ins, amount)方法进行落单</span>

    <span class="c1"># TODO: 开始编写你的算法吧！</span>

    <span class="c1"># 读取历史数据，使用sma方式计算均线准确度和数据长度无关，但是在使用ema方式计算均线时建议将历史数据窗口适当放大，结果会更加准确</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">history_bars</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">OBSERVATION</span><span class="p">,</span><span class="s1">&#39;1d&#39;</span><span class="p">,</span><span class="s1">&#39;close&#39;</span><span class="p">)</span>

    <span class="c1"># 用Talib计算MACD取值，得到三个时间序列数组，分别为macd, signal 和 hist</span>
    <span class="n">macd</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">hist</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">MACD</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">SHORTPERIOD</span><span class="p">,</span>
                                    <span class="n">context</span><span class="o">.</span><span class="n">LONGPERIOD</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">SMOOTHPERIOD</span><span class="p">)</span>

    <span class="n">plot</span><span class="p">(</span><span class="s2">&quot;macd&quot;</span><span class="p">,</span> <span class="n">macd</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">plot</span><span class="p">(</span><span class="s2">&quot;macd signal&quot;</span><span class="p">,</span> <span class="n">signal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># macd 是长短均线的差值，signal是macd的均线，使用macd策略有几种不同的方法，我们这里采用macd线突破signal线的判断方法</span>

    <span class="c1"># 如果macd从上往下跌破macd_signal</span>

    <span class="k">if</span> <span class="n">macd</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">signal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">macd</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">signal</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># 计算现在portfolio中股票的仓位</span>
        <span class="n">curPosition</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">]</span><span class="o">.</span><span class="n">quantity</span>
        <span class="c1">#进行清仓</span>
        <span class="k">if</span> <span class="n">curPosition</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">order_target_value</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># 如果短均线从下往上突破长均线，为入场信号</span>
    <span class="k">if</span> <span class="n">macd</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">signal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">macd</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">signal</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># 满仓入股</span>
        <span class="n">order_target_percent</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="rsi">
<h2>多股票RSI算法示例<a class="headerlink" href="#rsi" title="永久链接至标题">¶</a></h2>
<p>以下是一个我们使用TALib编写的多股票RSI算法示例，使用了TALib的RSI方法：</p>
<div class="highlight-python3"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">talib</span>


<span class="c1"># 在这个方法中编写任何的初始化逻辑。context对象将会在你的算法策略的任何方法之间做传递。</span>
<span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>

    <span class="c1"># 选择我们感兴趣的股票</span>
    <span class="n">context</span><span class="o">.</span><span class="n">s1</span> <span class="o">=</span> <span class="s2">&quot;000001.XSHE&quot;</span>
    <span class="n">context</span><span class="o">.</span><span class="n">s2</span> <span class="o">=</span> <span class="s2">&quot;601988.XSHG&quot;</span>
    <span class="n">context</span><span class="o">.</span><span class="n">s3</span> <span class="o">=</span> <span class="s2">&quot;000068.XSHE&quot;</span>
    <span class="n">context</span><span class="o">.</span><span class="n">stocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">s2</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">s3</span><span class="p">]</span>

    <span class="n">context</span><span class="o">.</span><span class="n">TIME_PERIOD</span> <span class="o">=</span> <span class="mi">14</span>
    <span class="n">context</span><span class="o">.</span><span class="n">HIGH_RSI</span> <span class="o">=</span> <span class="mi">85</span>
    <span class="n">context</span><span class="o">.</span><span class="n">LOW_RSI</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="n">context</span><span class="o">.</span><span class="n">ORDER_PERCENT</span> <span class="o">=</span> <span class="mf">0.3</span>


<span class="c1"># 你选择的证券的数据更新将会触发此段逻辑，例如日或分钟历史数据切片或者是实时数据切片更新</span>
<span class="k">def</span> <span class="nf">handle_bar</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">bar_dict</span><span class="p">):</span>
    <span class="c1"># 开始编写你的主要的算法逻辑</span>

    <span class="c1"># bar_dict[order_book_id] 可以拿到某个证券的bar信息</span>
    <span class="c1"># context.portfolio 可以拿到现在的投资组合状态信息</span>

    <span class="c1"># 使用order_shares(id_or_ins, amount)方法进行落单</span>

    <span class="c1"># TODO: 开始编写你的算法吧！</span>

    <span class="c1"># 对我们选中的股票集合进行loop，运算每一只股票的RSI数值</span>
    <span class="k">for</span> <span class="n">stock</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">stocks</span><span class="p">:</span>
        <span class="c1"># 读取历史数据</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">history_bars</span><span class="p">(</span><span class="n">stock</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">TIME_PERIOD</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;1d&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">)</span>

        <span class="c1"># 用Talib计算RSI值</span>
        <span class="n">rsi_data</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">RSI</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">timeperiod</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">TIME_PERIOD</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">cur_position</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">stock</span><span class="p">]</span><span class="o">.</span><span class="n">quantity</span>
        <span class="c1"># 用剩余现金的30%来购买新的股票</span>
        <span class="n">target_available_cash</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">cash</span> <span class="o">*</span> <span class="n">context</span><span class="o">.</span><span class="n">ORDER_PERCENT</span>

        <span class="c1"># 当RSI大于设置的上限阀值，清仓该股票</span>
        <span class="k">if</span> <span class="n">rsi_data</span> <span class="o">&gt;</span> <span class="n">context</span><span class="o">.</span><span class="n">HIGH_RSI</span> <span class="ow">and</span> <span class="n">cur_position</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">order_target_value</span><span class="p">(</span><span class="n">stock</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># 当RSI小于设置的下限阀值，用剩余cash的一定比例补仓该股</span>
        <span class="k">if</span> <span class="n">rsi_data</span> <span class="o">&lt;</span> <span class="n">context</span><span class="o">.</span><span class="n">LOW_RSI</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;target available cash caled: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">target_available_cash</span><span class="p">))</span>
            <span class="c1"># 如果剩余的现金不够一手 - 100shares，那么会被ricequant 的order management system reject掉</span>
            <span class="n">order_value</span><span class="p">(</span><span class="n">stock</span><span class="p">,</span> <span class="n">target_available_cash</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id3">
<h2>海龟交易系统<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<p>海龟交易系统也是非常经典的一种策略，我们也放出了范例代码如下，而关于海龟交易系统的介绍也可以参照 <a class="reference external" href="https://www.ricequant.com/community/topic/62/%E8%B6%8B%E5%8A%BF%E7%AD%96%E7%95%A5%E5%B0%8F%E8%AF%95%E7%89%9B%E5%88%80-%E6%B5%B7%E9%BE%9F%E4%BA%A4%E6%98%93%E4%BD%93%E7%B3%BB%E7%9A%84%E6%9E%84%E5%BB%BA">这篇帖子</a> 。</p>
<div class="highlight-python3"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">talib</span>
<span class="kn">import</span> <span class="nn">math</span>


<span class="k">def</span> <span class="nf">get_extreme</span><span class="p">(</span><span class="n">array_high_price_result</span><span class="p">,</span> <span class="n">array_low_price_result</span><span class="p">):</span>
    <span class="n">np_array_high_price_result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">array_high_price_result</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">np_array_low_price_result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">array_low_price_result</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">max_result</span> <span class="o">=</span> <span class="n">np_array_high_price_result</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">min_result</span> <span class="o">=</span> <span class="n">np_array_low_price_result</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">max_result</span><span class="p">,</span> <span class="n">min_result</span><span class="p">]</span>


<span class="k">def</span>  <span class="nf">get_atr_and_unit</span><span class="p">(</span> <span class="n">atr_array_result</span><span class="p">,</span>  <span class="n">atr_length_result</span><span class="p">,</span> <span class="n">portfolio_value_result</span><span class="p">):</span>
    <span class="n">atr</span> <span class="o">=</span>  <span class="n">atr_array_result</span><span class="p">[</span> <span class="n">atr_length_result</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">unit</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">portfolio_value_result</span> <span class="o">*</span> <span class="o">.</span><span class="mi">01</span> <span class="o">/</span> <span class="n">atr</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">atr</span><span class="p">,</span> <span class="n">unit</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">get_stop_price</span><span class="p">(</span><span class="n">first_open_price_result</span><span class="p">,</span> <span class="n">units_hold_result</span><span class="p">,</span> <span class="n">atr_result</span><span class="p">):</span>
    <span class="n">stop_price</span> <span class="o">=</span> <span class="n">first_open_price_result</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">atr_result</span> \
                 <span class="o">+</span> <span class="p">(</span><span class="n">units_hold_result</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">atr_result</span>
    <span class="k">return</span> <span class="n">stop_price</span>


<span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="n">context</span><span class="o">.</span><span class="n">trade_day_num</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">context</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">context</span><span class="o">.</span><span class="n">atr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">context</span><span class="o">.</span><span class="n">trading_signal</span> <span class="o">=</span> <span class="s1">&#39;start&#39;</span>
    <span class="n">context</span><span class="o">.</span><span class="n">pre_trading_signal</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">context</span><span class="o">.</span><span class="n">units_hold_max</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">context</span><span class="o">.</span><span class="n">units_hold</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">context</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">context</span><span class="o">.</span><span class="n">max_add</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">context</span><span class="o">.</span><span class="n">first_open_price</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">context</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;000300.XSHG&#39;</span>
    <span class="n">context</span><span class="o">.</span><span class="n">open_observe_time</span> <span class="o">=</span> <span class="mi">55</span>
    <span class="n">context</span><span class="o">.</span><span class="n">close_observe_time</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">context</span><span class="o">.</span><span class="n">atr_time</span> <span class="o">=</span> <span class="mi">20</span>


<span class="k">def</span> <span class="nf">handle_bar</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">bar_dict</span><span class="p">):</span>
    <span class="n">portfolio_value</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">portfolio_value</span>
    <span class="n">high_price</span> <span class="o">=</span> <span class="n">history_bars</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">open_observe_time</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;1d&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">)</span>
    <span class="n">low_price_for_atr</span> <span class="o">=</span> <span class="n">history_bars</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">open_observe_time</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;1d&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">)</span>
    <span class="n">low_price_for_extreme</span> <span class="o">=</span> <span class="n">history_bars</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">close_observe_time</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;1d&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">)</span>
    <span class="n">close_price</span> <span class="o">=</span> <span class="n">history_bars</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">open_observe_time</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;1d&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">)</span>
    <span class="n">close_price_for_atr</span> <span class="o">=</span> <span class="n">close_price</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">atr_array</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">ATR</span><span class="p">(</span><span class="n">high_price</span><span class="p">,</span> <span class="n">low_price_for_atr</span><span class="p">,</span> <span class="n">close_price_for_atr</span><span class="p">,</span> <span class="n">timeperiod</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">atr_time</span><span class="p">)</span>

    <span class="n">maxx</span> <span class="o">=</span> <span class="n">get_extreme</span><span class="p">(</span><span class="n">high_price</span><span class="p">,</span> <span class="n">low_price_for_extreme</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">minn</span> <span class="o">=</span> <span class="n">get_extreme</span><span class="p">(</span><span class="n">high_price</span><span class="p">,</span> <span class="n">low_price_for_extreme</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">atr</span> <span class="o">=</span> <span class="n">atr_array</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">trading_signal</span> <span class="o">!=</span> <span class="s1">&#39;start&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">units_hold</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">max_add</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">get_atr_and_unit</span><span class="p">(</span><span class="n">atr_array</span><span class="p">,</span> <span class="n">atr_array</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">portfolio_value</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">context</span><span class="o">.</span><span class="n">max_add</span> <span class="o">=</span> <span class="n">bar_dict</span><span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">last</span>

    <span class="n">cur_position</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">quantity</span>
    <span class="n">available_cash</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">cash</span>
    <span class="n">market_value</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">market_value</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">cur_position</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span>
            <span class="n">bar_dict</span><span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">last</span> <span class="o">&lt;</span> <span class="n">get_stop_price</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">first_open_price</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">units_hold</span><span class="p">,</span> <span class="n">atr</span><span class="p">)):</span>
        <span class="n">context</span><span class="o">.</span><span class="n">trading_signal</span> <span class="o">=</span> <span class="s1">&#39;stop&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cur_position</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">bar_dict</span><span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">last</span> <span class="o">&lt;</span> <span class="n">minn</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">trading_signal</span> <span class="o">=</span> <span class="s1">&#39;exit&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">bar_dict</span><span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">last</span> <span class="o">&gt;</span> <span class="n">context</span><span class="o">.</span><span class="n">max_add</span> <span class="ow">and</span> <span class="n">context</span><span class="o">.</span><span class="n">units_hold</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">units_hold</span> <span class="o">&lt;</span> <span class="n">context</span><span class="o">.</span><span class="n">units_hold_max</span> <span class="ow">and</span>
                    <span class="n">available_cash</span> <span class="o">&gt;</span> <span class="n">bar_dict</span><span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">last</span><span class="o">*</span><span class="n">context</span><span class="o">.</span><span class="n">unit</span><span class="p">):</span>
                <span class="n">context</span><span class="o">.</span><span class="n">trading_signal</span> <span class="o">=</span> <span class="s1">&#39;entry_add&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bar_dict</span><span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">last</span> <span class="o">&gt;</span> <span class="n">maxx</span> <span class="ow">and</span> <span class="n">context</span><span class="o">.</span><span class="n">units_hold</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">max_add</span> <span class="o">=</span> <span class="n">bar_dict</span><span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">last</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">trading_signal</span> <span class="o">=</span> <span class="s1">&#39;entry&#39;</span>

    <span class="n">atr</span> <span class="o">=</span> <span class="n">get_atr_and_unit</span><span class="p">(</span><span class="n">atr_array</span><span class="p">,</span> <span class="n">atr_array</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">portfolio_value</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">trade_day_num</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">context</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">get_atr_and_unit</span><span class="p">(</span><span class="n">atr_array</span><span class="p">,</span> <span class="n">atr_array</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">portfolio_value</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">context</span><span class="o">.</span><span class="n">trade_day_num</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">context</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">unit</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">trading_signal</span> <span class="o">!=</span> <span class="n">context</span><span class="o">.</span><span class="n">pre_trading_signal</span> <span class="ow">or</span>
            <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">units_hold</span> <span class="o">&lt;</span> <span class="n">context</span><span class="o">.</span><span class="n">units_hold_max</span> <span class="ow">and</span> <span class="n">context</span><span class="o">.</span><span class="n">units_hold</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">context</span><span class="o">.</span><span class="n">trading_signal</span> <span class="o">==</span> <span class="s1">&#39;stop&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">trading_signal</span> <span class="o">==</span> <span class="s1">&#39;entry&#39;</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">unit</span>
            <span class="k">if</span> <span class="n">available_cash</span> <span class="o">&gt;</span> <span class="n">bar_dict</span><span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">last</span><span class="o">*</span><span class="n">context</span><span class="o">.</span><span class="n">quantity</span><span class="p">:</span>
                <span class="n">order_shares</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">first_open_price</span> <span class="o">=</span> <span class="n">bar_dict</span><span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">last</span>
                <span class="n">context</span><span class="o">.</span><span class="n">units_hold</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">trading_signal</span> <span class="o">==</span> <span class="s1">&#39;entry_add&#39;</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">unit</span>
            <span class="n">order_shares</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">units_hold</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">trading_signal</span> <span class="o">==</span> <span class="s1">&#39;stop&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">units_hold</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">order_shares</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="o">-</span><span class="n">context</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">units_hold</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">trading_signal</span> <span class="o">==</span> <span class="s1">&#39;exit&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cur_position</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">order_shares</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="o">-</span><span class="n">cur_position</span><span class="p">)</span>
                <span class="n">context</span><span class="o">.</span><span class="n">units_hold</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">context</span><span class="o">.</span><span class="n">pre_trading_signal</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">trading_signal</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id5">
<h2>股指期货MACD日回测<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h2>
<p>以下是一个使用TALib进行股指期货主力合约日级别回测MACD算法示例：</p>
<div class="highlight-python3"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># 可以自己import我们平台支持的第三方python模块，比如pandas、numpy等</span>
<span class="kn">import</span> <span class="nn">talib</span>


<span class="c1"># 在这个方法中编写任何的初始化逻辑。context对象将会在你的算法策略的任何方法之间做传递</span>
<span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="c1"># context内引入全局变量s1，存储目标合约信息</span>
    <span class="n">context</span><span class="o">.</span><span class="n">s1</span> <span class="o">=</span> <span class="s1">&#39;IF1606&#39;</span>

    <span class="c1"># 使用MACD需要设置长短均线和macd平均线的参数</span>
    <span class="n">context</span><span class="o">.</span><span class="n">SHORTPERIOD</span> <span class="o">=</span> <span class="mi">12</span>
    <span class="n">context</span><span class="o">.</span><span class="n">LONGPERIOD</span> <span class="o">=</span> <span class="mi">26</span>
    <span class="n">context</span><span class="o">.</span><span class="n">SMOOTHPERIOD</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="n">context</span><span class="o">.</span><span class="n">OBSERVATION</span> <span class="o">=</span> <span class="mi">50</span>

    <span class="c1">#初始化时订阅合约行情。订阅之后的合约行情会在handle_bar中进行更新</span>
    <span class="n">subscribe</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">)</span>


<span class="c1"># 你选择的期货数据更新将会触发此段逻辑，例如日线或分钟线更新</span>
<span class="k">def</span> <span class="nf">handle_bar</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">bar_dict</span><span class="p">):</span>
    <span class="c1"># 开始编写你的主要的算法逻辑</span>
    <span class="c1"># 获取历史收盘价序列，history_bars函数直接返回ndarray，方便之后的有关指标计算</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">history_bars</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">OBSERVATION</span><span class="p">,</span> <span class="s1">&#39;1d&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">)</span>

    <span class="c1"># 用Talib计算MACD取值，得到三个时间序列数组，分别为macd,signal 和 hist</span>
    <span class="n">macd</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">hist</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">MACD</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">SHORTPERIOD</span><span class="p">,</span>
                                    <span class="n">context</span><span class="o">.</span><span class="n">LONGPERIOD</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">SMOOTHPERIOD</span><span class="p">)</span>

    <span class="c1"># macd 是长短均线的差值，signal是macd的均线，如果短均线从下往上突破长均线，为入场信号，进行买入开仓操作</span>
    <span class="k">if</span> <span class="n">macd</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">signal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">macd</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">signal</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sell_qty</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">]</span><span class="o">.</span><span class="n">sell_quantity</span>
        <span class="c1"># 先判断当前卖方仓位，如果有，则进行平仓操作</span>
        <span class="k">if</span> <span class="n">sell_qty</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">buy_close</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># 买入开仓</span>
        <span class="n">buy_open</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">macd</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">signal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">macd</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">signal</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">buy_qty</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">]</span><span class="o">.</span><span class="n">buy_quantity</span>
        <span class="c1"># 先判断当前买方仓位，如果有，则进行平仓操作</span>
        <span class="k">if</span> <span class="n">buy_qty</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sell_close</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># 卖出开仓</span>
        <span class="n">sell_open</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id6">
<h2>商品期货跨品种配对交易<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h2>
<p>该策略为分钟级别回测。运用了简单的移动平均以及布林带（<a class="reference external" href="https://en.wikipedia.org/wiki/Bollinger_Bands">Bollinger Bands</a>）作为交易信号产生源。有关对冲比率（HedgeRatio）的确定，您可以在我们的研究平台上面通过import statsmodels.api as sm引入 <a class="reference external" href="http://statsmodels.sourceforge.net/devel/">statsmodels</a> 中的OLS方法进行线性回归估计。具体估计窗口，您可以根据自己策略需要自行选择。</p>
<p>策略中的移动窗口选择为60分钟，即在每天开盘60分钟内不做任何交易，积累数据计算移动平均值。当然，这一移动窗口也可以根据自身需要进行灵活选择。下面例子中使用了黄金与白银两种商品期货进行配对交易。简单起见，例子中期货的价格并未做对数差处理。</p>
<div class="highlight-python3"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="c1"># 在这个方法中编写任何的初始化逻辑。context对象将会在你的算法策略的任何方法之间做传递。</span>
<span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="n">context</span><span class="o">.</span><span class="n">s1</span> <span class="o">=</span> <span class="s1">&#39;AG1612&#39;</span>
    <span class="n">context</span><span class="o">.</span><span class="n">s2</span> <span class="o">=</span> <span class="s1">&#39;AU1612&#39;</span>

    <span class="c1"># 设置全局计数器</span>
    <span class="n">context</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># 设置滚动窗口</span>
    <span class="n">context</span><span class="o">.</span><span class="n">window</span> <span class="o">=</span> <span class="mi">60</span>

    <span class="c1"># 设置对冲手数,通过研究历史数据进行价格序列回归得到该值</span>
    <span class="n">context</span><span class="o">.</span><span class="n">ratio</span> <span class="o">=</span> <span class="mi">15</span>

    <span class="n">context</span><span class="o">.</span><span class="n">up_cross_up_limit</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">context</span><span class="o">.</span><span class="n">down_cross_down_limit</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># 设置入场临界值</span>
    <span class="n">context</span><span class="o">.</span><span class="n">entry_score</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="c1"># 初始化时订阅合约行情。订阅之后的合约行情会在handle_bar中进行更新</span>
    <span class="n">subscribe</span><span class="p">([</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">s2</span><span class="p">])</span>


<span class="c1"># before_trading此函数会在每天交易开始前被调用，当天只会被调用一次</span>
<span class="k">def</span> <span class="nf">before_trading</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="c1"># 样例商品期货在回测区间内有夜盘交易,所以在每日开盘前将计数器清零</span>
    <span class="n">context</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>


<span class="c1"># 你选择的期货数据更新将会触发此段逻辑，例如日线或分钟线更新</span>
<span class="k">def</span> <span class="nf">handle_bar</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">bar_dict</span><span class="p">):</span>

    <span class="c1"># 获取当前一对合约的仓位情况。如尚未有仓位,则对应持仓量都为0</span>
    <span class="n">position_a</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">]</span>
    <span class="n">position_b</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">s2</span><span class="p">]</span>

    <span class="n">context</span><span class="o">.</span><span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># 当累积满一定数量的bar数据时候,进行交易逻辑的判断</span>
    <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">counter</span> <span class="o">&gt;</span> <span class="n">context</span><span class="o">.</span><span class="n">window</span><span class="p">:</span>

        <span class="c1"># 获取当天历史分钟线价格队列</span>
        <span class="n">price_array_a</span> <span class="o">=</span> <span class="n">history_bars</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">window</span><span class="p">,</span> <span class="s1">&#39;1m&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">)</span>
        <span class="n">price_array_b</span> <span class="o">=</span> <span class="n">history_bars</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s2</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">window</span><span class="p">,</span> <span class="s1">&#39;1m&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">)</span>

        <span class="c1"># 计算价差序列、其标准差、均值、上限、下限</span>
        <span class="n">spread_array</span> <span class="o">=</span> <span class="n">price_array_a</span> <span class="o">-</span> <span class="n">context</span><span class="o">.</span><span class="n">ratio</span> <span class="o">*</span> <span class="n">price_array_b</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">spread_array</span><span class="p">)</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spread_array</span><span class="p">)</span>
        <span class="n">up_limit</span> <span class="o">=</span> <span class="n">mean</span> <span class="o">+</span> <span class="n">context</span><span class="o">.</span><span class="n">entry_score</span> <span class="o">*</span> <span class="n">std</span>
        <span class="n">down_limit</span> <span class="o">=</span> <span class="n">mean</span> <span class="o">-</span> <span class="n">context</span><span class="o">.</span><span class="n">entry_score</span> <span class="o">*</span> <span class="n">std</span>

        <span class="c1"># 获取当前bar对应合约的收盘价格并计算价差</span>
        <span class="n">price_a</span> <span class="o">=</span> <span class="n">bar_dict</span><span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">]</span><span class="o">.</span><span class="n">close</span>
        <span class="n">price_b</span> <span class="o">=</span> <span class="n">bar_dict</span><span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">s2</span><span class="p">]</span><span class="o">.</span><span class="n">close</span>
        <span class="n">spread</span> <span class="o">=</span> <span class="n">price_a</span> <span class="o">-</span> <span class="n">context</span><span class="o">.</span><span class="n">ratio</span> <span class="o">*</span> <span class="n">price_b</span>

        <span class="c1"># 如果价差低于预先计算得到的下限,则为建仓信号,&#39;买入&#39;价差合约</span>
        <span class="k">if</span> <span class="n">spread</span> <span class="o">&lt;=</span> <span class="n">down_limit</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">down_cross_down_limit</span><span class="p">:</span>
            <span class="c1"># 可以通过logger打印日志</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;spread: </span><span class="si">{}</span><span class="s1">, mean: </span><span class="si">{}</span><span class="s1">, down_limit: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spread</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">down_limit</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;创建买入价差中...&#39;</span><span class="p">)</span>

            <span class="c1"># 获取当前剩余的应建仓的数量</span>
            <span class="n">qty_a</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">position_a</span><span class="o">.</span><span class="n">buy_quantity</span>
            <span class="n">qty_b</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">ratio</span> <span class="o">-</span> <span class="n">position_b</span><span class="o">.</span><span class="n">sell_quantity</span>

            <span class="c1"># 由于存在成交不超过下一bar成交量25%的限制,所以可能要通过多次发单成交才能够成功建仓</span>
            <span class="k">if</span> <span class="n">qty_a</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">buy_open</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">,</span> <span class="n">qty_a</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">qty_b</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sell_open</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s2</span><span class="p">,</span> <span class="n">qty_b</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">qty_a</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">qty_b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># 已成功建立价差的&#39;多仓&#39;</span>
                <span class="n">context</span><span class="o">.</span><span class="n">down_cross_down_limit</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;买入价差仓位创建成功!&#39;</span><span class="p">)</span>

        <span class="c1"># 如果价差向上回归移动平均线,则为平仓信号</span>
        <span class="k">if</span> <span class="n">spread</span> <span class="o">&gt;=</span> <span class="n">mean</span> <span class="ow">and</span> <span class="n">context</span><span class="o">.</span><span class="n">down_cross_down_limit</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;spread: </span><span class="si">{}</span><span class="s1">, mean: </span><span class="si">{}</span><span class="s1">, down_limit: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spread</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">down_limit</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;对买入价差仓位进行平仓操作中...&#39;</span><span class="p">)</span>

            <span class="c1"># 由于存在成交不超过下一bar成交量25%的限制,所以可能要通过多次发单成交才能够成功建仓</span>
            <span class="n">qty_a</span> <span class="o">=</span> <span class="n">position_a</span><span class="o">.</span><span class="n">buy_quantity</span>
            <span class="n">qty_b</span> <span class="o">=</span> <span class="n">position_b</span><span class="o">.</span><span class="n">sell_quantity</span>
            <span class="k">if</span> <span class="n">qty_a</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sell_close</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">,</span> <span class="n">qty_a</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">qty_b</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">buy_close</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s2</span><span class="p">,</span> <span class="n">qty_b</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">qty_a</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">qty_b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">down_cross_down_limit</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;买入价差仓位平仓成功!&#39;</span><span class="p">)</span>

        <span class="c1"># 如果价差高于预先计算得到的上限,则为建仓信号,&#39;卖出&#39;价差合约</span>
        <span class="k">if</span> <span class="n">spread</span> <span class="o">&gt;=</span> <span class="n">up_limit</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">up_cross_up_limit</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;spread: </span><span class="si">{}</span><span class="s1">, mean: </span><span class="si">{}</span><span class="s1">, up_limit: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spread</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">up_limit</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;创建卖出价差中...&#39;</span><span class="p">)</span>
            <span class="n">qty_a</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">position_a</span><span class="o">.</span><span class="n">sell_quantity</span>
            <span class="n">qty_b</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">ratio</span> <span class="o">-</span> <span class="n">position_b</span><span class="o">.</span><span class="n">buy_quantity</span>
            <span class="k">if</span> <span class="n">qty_a</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sell_open</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">,</span> <span class="n">qty_a</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">qty_b</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">buy_open</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s2</span><span class="p">,</span> <span class="n">qty_b</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">qty_a</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">qty_b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">up_cross_up_limit</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;卖出价差仓位创建成功&#39;</span><span class="p">)</span>

        <span class="c1"># 如果价差向下回归移动平均线,则为平仓信号</span>
        <span class="k">if</span> <span class="n">spread</span> <span class="o">&lt;</span> <span class="n">mean</span> <span class="ow">and</span> <span class="n">context</span><span class="o">.</span><span class="n">up_cross_up_limit</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;spread: </span><span class="si">{}</span><span class="s1">, mean: </span><span class="si">{}</span><span class="s1">, up_limit: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spread</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">up_limit</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;对卖出价差仓位进行平仓操作中...&#39;</span><span class="p">)</span>
            <span class="n">qty_a</span> <span class="o">=</span> <span class="n">position_a</span><span class="o">.</span><span class="n">sell_quantity</span>
            <span class="n">qty_b</span> <span class="o">=</span> <span class="n">position_b</span><span class="o">.</span><span class="n">buy_quantity</span>
            <span class="k">if</span> <span class="n">qty_a</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">buy_close</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s1</span><span class="p">,</span> <span class="n">qty_a</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">qty_b</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sell_close</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">s2</span><span class="p">,</span> <span class="n">qty_b</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">qty_a</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">qty_b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">up_cross_up_limit</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;卖出价差仓位平仓成功!&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="detail_install.html" class="btn btn-neutral float-right" title="环境搭建" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="tutorial.html" class="btn btn-neutral" title="入门教程" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, MooQuant.
      最后更新于 9月 13, 2017.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.2.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/translations.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
  
 
<script type="text/javascript">
    console.log("Powered By MooQuant.");
</script>


</body>
</html>